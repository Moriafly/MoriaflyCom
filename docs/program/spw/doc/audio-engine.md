# SPW 音频引擎

## DirectX（DirectSound）

Windows 10/11 上重定向到 Windows 音频会话 API 共享模式，仅做为选项。

## Windows 音频会话 API（WASAPI）

### 共享模式和独占模式的区别

#### 重采样（SRC）说明

当有音频输出硬件（如耳机）支持 44.1 kHz 和 48 kHz，音频文件 A（44.1 kHz）和 B（48 kHz）。

**共享模式下：** Windows 音量合成器会显示硬件支持的采样率选项：44.1 kHz 和 48 kHz，当用户选择 44.1 kHz，Windows 会将软件传输给系统的音频采样率转换为 44.1 kHz 后输出给硬件。（暂不考虑软件自己混音的情况下）软件播放音频文件 A 给系统，同为 44.1 kHz，未发生采样率转换；软件播放音频文件 B 给系统，输出的音频采样率和指定采样率不一致，需要进行 44.1 kHz -> 48 kHz 的转换。

**共享模式下考虑软件的混音：** 早期 Windows 系统（同时如早期 Android 系统）的采样率转换质量并不高，对于现在系统（软件及硬件）拥有高质量的采样率转换，接近无损。软件方可自实现混音采样率转换，如软件可以先将音频重采用到特定的频率，如都采样到 96 kHz，这时候播放到 A 歌曲（44.1 kHz -> 软件内部 SRC -> 96 kHz -> 系统 SRC -> 48 kHz -> 硬件），但这个地方设置为 96 kHz 没什么意义并消耗资源，使用软件一般在要实现自混音要先匹配 Windows 系统设置，如此处设置为 48 kHz，即（44.1 kHz -> 软件内部 SRC -> 48 kHz -> 系统 SRC -> 48 kHz -> 硬件），这部分可以看到具体哪里发生 SRC（软件内部还是系统？）是可以通过软件的行为控制的，同时软件最好至少匹配音频或者系统（推荐系统）以避免二次重新采样。

**独占模式下（仅谈论 SRC）：** WASAPI 的独占模式，即相当于软件可以直接请求硬件，可以和系统设置不一样，如 Windows 音量合成器设置 44.1 kHz，但软件可以直接请求 48 kHz，意思在于软件可以在这种情况下担当自己的系统行为。独占的意思是此仅当前软件可以访问此硬件。这时候和共享模式的区别可以简单理解为少了系统参与，类似（44.1 kHz -> 软件内部 SRC -> 48 kHz -> 硬件），也可以（44.1 kHz -> 软件内部 SRC -> 44.1 kHz -> 硬件）。网络很流行的说法**“避免 SRC”**仅指的是避开了系统的 SRC，因为系统可以视为未参与，但共享模式下也可以避免，这还是具体看是否采样率一致。独占模式和实际是否 SRC 没有必然关系，采样率匹配需要软件和硬件同时行为满足。

一些场景的要实现无采样率转换的行为，软件读取音频文件采样率，并以此采样率请求硬件，若硬件支持即播放。切歌后检测新音频文件采样率，若发生改变，进行重新初始化请求硬件，若硬件支持即播放。此流程存在的问题：1. 载入的音频文件发生采样率变化无法实现无间隙播放，因为采样率不同需要重新请求硬件。2. 若存在硬件不支持的音频文件采样率，依旧需要发生采样率转换以正常播放。

SPW 采取了一种特定的流程，在独占模式下，读取 Windows 音量合成器的选项（仅做为数据读取），符合用户的主需求，并以此采样率在独占模式下请求硬件。在播放过程中将音频文件混音到此指定采样率并输出。是否发生 SRC 看音频文件和 SPW 的输出采样率（同于 Windows 音量合成器设置）。好处：1. 实现无间隙播放。3. 符合用户主要的需求设置，在采样率匹配的时候也不会发生采样率转换。

SPW 拥有高质量的采样率转换，Windows 的采样率转换也很好，几乎无损，SPW 目前的方式也是好的选择，Android 版本开启强制会采取之前的方式。

Android 上的独占和 Windows 的逻辑都大概一样的，只是 Android 并没有系统 API 方便访问，需要另外的开发对 USB 设备等访问。Android 上常在一些社区听到的 48 kHz、SRC 和具体设备有关，并非 Android 特定设置。

是否需要选择高采样率？对于听歌来说，没有必要，推荐设置 48 kHz 以匹配主流文件。

是否需要打开独占模式？独占模式还可以绕过 Windows 的混音，具体看需求。同时独占模式会降低延迟，也具体看喜好，几十毫秒的差距，听歌来说没什么必要性，场景如果是 K 歌情况推荐打开。独占模式会导致其他软件音频无法输出到此硬件。综上，单纯听歌，不推荐使用独占模式。